<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Setup 2FA - VibeNest</title>
  <link rel="stylesheet" href="/css/theme.css">
  <style>
    .setup-2fa-container {
      max-width: 500px;
      margin: 40px auto;
      padding: 32px;
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .setup-2fa-container h2 {
      color: var(--accent);
      margin-top: 0;
      text-align: center;
    }
    .tabs {
      display: flex;
      gap: 0;
      border-bottom: 2px solid var(--border);
      margin: 24px 0;
    }
    .tab-btn {
      flex: 1;
      padding: 12px;
      background: transparent;
      border: none;
      color: var(--muted);
      font-weight: 600;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }
    .tab-btn.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .qr-container {
      background: white;
      padding: 12px;
      border-radius: 8px;
      display: inline-block;
      margin: 20px 0;
    }
    .qr-container img {
      max-width: 100%;
      height: auto;
    }
    .secret-key {
      background: var(--focus);
      padding: 12px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 0.95rem;
      margin: 16px 0;
      word-break: break-all;
      user-select: all;
    }
    .error-message {
      color: var(--danger);
      background: rgba(255,107,107,0.1);
      padding: 12px;
      border-radius: 8px;
      margin: 16px 0;
    }
    .success-message {
      color: var(--success);
      background: rgba(60,207,142,0.1);
      padding: 12px;
      border-radius: 8px;
      margin: 16px 0;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
    }
    .form-group input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--card);
      color: var(--text);
    }
    .backup-codes-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 8px;
      margin: 16px 0;
      list-style: none;
      padding: 0;
    }
    .backup-codes-list li {
      padding: 8px;
      border: 1px dashed var(--border);
      border-radius: 6px;
      background: var(--focus);
      font-family: monospace;
      font-size: 0.85rem;
      text-align: center;
    }
    .button-group {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .button-group button {
      flex: 1;
    }
  </style>
</head>
<body>
  <%- include('partials/header') %>
  
  <div class="setup-2fa-container">
    <h2>Two-Factor Authentication Setup</h2>
    <p style="color: var(--muted); text-align: center;">Secure your account with two-factor authentication</p>

    <% if (error) { %>
      <div class="error-message"><%= error %></div>
    <% } %>
    <% if (message) { %>
      <div class="success-message"><%= message %></div>
    <% } %>

    <!-- Display backup codes if just enabled -->
    <% if (typeof plainCodes !== 'undefined' && plainCodes && plainCodes.length) { %>
      <div style="background: var(--focus); padding: 16px; border-radius: 8px; margin-bottom: 24px;">
        <h3 style="margin-top: 0;">Save Your Backup Codes</h3>
        <p style="color: var(--muted); font-size: 0.9rem;">These codes are shown only once. Store them in a safe place — each code can be used once if you lose access to your authenticator.</p>
        <ul class="backup-codes-list">
          <% plainCodes.forEach(code => { %>
            <li><%= code %></li>
          <% }) %>
        </ul>
        <div class="button-group">
          <button id="download-codes" class="btn ghost">Download</button>
          <button id="copy-codes" class="btn">Copy All</button>
        </div>
      </div>
    <% } %>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="app">Authenticator App</button>
      <button class="tab-btn" data-tab="email">Email</button>
    </div>

    <!-- Authenticator App Tab -->
    <div id="app-content" class="tab-content active">
      <p>Use an authenticator app like Google Authenticator, Authy, or Microsoft Authenticator.</p>
      
      <p style="font-weight: 600; margin-top: 20px;">1. Scan the QR code:</p>
      <div style="text-align: center;">
        <div class="qr-container">
          <% if (qrCodeImage) { %>
            <img src="<%= qrCodeImage %>" alt="QR Code for 2FA setup" />
          <% } else { %>
            <p style="color: var(--danger);">QR code not available. Try again later.</p>
          <% } %>
        </div>
      </div>

      <p style="font-weight: 600;">Or enter this key manually:</p>
      <div class="secret-key"><%= secret %></div>

      <p style="font-weight: 600; margin-top: 20px;">2. Enter the 6-digit code:</p>
      <form action="/setup-2fa" method="POST">
        <input type="hidden" name="secret" value="<%= secret %>">
        <div class="form-group">
          <label for="token">Code from your authenticator</label>
          <input type="text" id="token" name="token" placeholder="000000" maxlength="6" inputmode="numeric" required autofocus />
        </div>
        <button type="submit" class="btn btn-primary">Enable Authenticator 2FA</button>
      </form>
    </div>

    <!-- Email Tab -->
    <div id="email-content" class="tab-content">
      <p>Receive a 6-digit code via email when you log in.</p>
      
      <form action="/enable-email-2fa" method="POST">
        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" name="email" value="<%= user.email %>" required readonly />
        </div>
        <button type="submit" class="btn btn-primary">Enable Email 2FA</button>
      </form>

      <p style="font-size: 0.85rem; color: var(--muted); margin-top: 16px;">A verification code will be sent to your email address each time you log in.</p>
    </div>
  </div>

  <script>
    // Tab switching
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(btn.dataset.tab + '-content').classList.add('active');
        });
      });
    });

    // Download / copy backup codes
    (() => {
      const codes = <%- JSON.stringify(typeof plainCodes !== 'undefined' ? plainCodes : []) %>;
      const download = document.getElementById('download-codes');
      const copyBtn = document.getElementById('copy-codes');

      if (download && codes.length) {
        download.addEventListener('click', () => {
          const blob = new Blob([codes.join('\n')], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'vibenest-backup-codes.txt';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        });
      }

      if (copyBtn && codes.length) {
        copyBtn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(codes.join('\n'));
            copyBtn.textContent = '✓ Copied';
            setTimeout(() => (copyBtn.textContent = 'Copy All'), 2000);
          } catch (e) {
            alert('Could not copy. Please copy manually.');
          }
        });
      }
    })();
  </script>
  <script src="/js/theme-toggle.js"></script>
</body>
</html>

